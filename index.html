<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv='Content-Type' content='text/html;charset=utf-8'/>
    <meta http-equiv="X-UA-Compatible" content="chrome=1,IE=edge" />
    <!--<script type='text/javascript' src='http://www.x3dom.org/download/x3dom.js'> </script>-->
    <!--<link rel='stylesheet' type='text/css' href='http://www.x3dom.org/download/x3dom.css'> </link>-->
    <script type="text/javascript" src="./x3dom/x3dom.js"></script>
    <link rel='stylesheet' type='text/css' href='./x3dom/x3dom.css'>
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
    <title>TFG - ASB</title>

</head>
<body style='width:100%; height:100%; border:0; margin:0; padding:0;'>
<div onclick="fullscreen();" id="fsbutton"><h1>Fullscreen<br/>Mode</h1></div>

    <x3d id='x3dElement' showStat='false' showLog='false' style='width:100%; height:100%; border:0; margin:0; padding:0;'>
        <scene>
            <Environment frustumCulling="false"></Environment>
            <navigationInfo type='"EXAMINE" "WALK"'></navigationInfo>
            <directionalLight id="directional" direction='-1 -1 -1' on ="TRUE" intensity='1.0' shadowIntensity='0.0'> </directionalLight>
            <background DEF='bgnd' skyColor="0.8 0.8 0.8"></background>
            <viewpoint id='vpp' DEF='vp' description='ViewPoint 1' centerOfRotation='3.4625 1.73998 -5.55' fieldOfView="1.5"
                       orientation='0 1 0 2.99229' position='2.17102 2.00905 -3.97228'
                       zNear="0.001" zFar="300"></viewpoint>

            <group id='root' render='false'>
                <group DEF='theScene'>

                    <inline url="./models/MyX3D.xml"></inline>

                </group>
            </group>

            <group DEF='left'>
                <shape>
                    <appearance>
                        <renderedTexture interpupillaryDistance="0.03" id="rtLeft" stereoMode="LEFT_EYE" update='ALWAYS'
                                         dimensions='960 1080 4' repeatS='false' repeatT='false'>
                            <viewpoint USE='vp' containerField='viewpoint'></viewpoint>
                            <background USE='bgnd' containerField='background'></background>
                            <!--group USE='left' containerField="excludeNodes"></group-->
                            <group USE='theScene' containerField="scene"></group>
                        </renderedTexture>
                        <composedShader>
                            <field name='tex' type='SFInt32' value='0'></field>
                            <field name='leftEye' type='SFFloat' value='1'></field>
                            <shaderPart type='VERTEX'>
                                attribute vec3 position;
                                attribute vec2 texcoord;

                                uniform mat4 modelViewProjectionMatrix;
                                varying vec2 fragTexCoord;

                                void main()
                                {
                                vec2 pos = sign(position.xy);
                                fragTexCoord = texcoord;

                                gl_Position = vec4((pos.x/2.0)-0.5, pos.y, 0.0, 1.0);
                                //    gl_Position = vec4((pos.x - 1.0) / 2.0, pos.y, 0.0, 1.0);

                                //gl_Position = vec4(pos.xy / 4.0 + vec2(-0.75,0.75), 0.0, 1.0);
                                }
                            </shaderPart>
                            <shaderPart DEF="frag" type='FRAGMENT'>
                                #ifdef GL_ES
                                precision highp float;
                                #endif

                                uniform sampler2D tex;
                                uniform float leftEye;
                                varying vec2 fragTexCoord;

                                void main()
                                {

                                gl_FragColor = texture2D(tex, fragTexCoord);
                                }
                            </shaderPart>
                        </composedShader>
                    </appearance>
                    <plane solid="false"></plane>
                </shape>
            </group>

            <group DEF='right'>
                <shape>
                    <appearance>
                        <renderedTexture interpupillaryDistance="0.03" id="rtRight" stereoMode="RIGHT_EYE" update='ALWAYS'
                                         dimensions='960 1080 4' repeatS='false' repeatT='false'>
                            <viewpoint USE='vp' containerField='viewpoint'></viewpoint>
                            <background USE='bgnd' containerField='background'></background>
                            <group USE='theScene' containerField="scene"></group>
                        </renderedTexture>
                        <composedShader>
                            <field name='tex' type='SFInt32' value='0'></field>
                            <field name='leftEye' type='SFFloat' value='0'></field>
                            <shaderPart type='VERTEX'>
                                attribute vec3 position;
                                attribute vec2 texcoord;

                                uniform mat4 modelViewProjectionMatrix;
                                varying vec2 fragTexCoord;

                                void main()
                                {
                                vec2 pos = sign(position.xy);
                                fragTexCoord = texcoord;

                                gl_Position = vec4((pos.x + 1.0) / 2.0, pos.y, 0.0, 1.0);
                                }
                            </shaderPart>
                            <shaderPart USE="frag" type='FRAGMENT'>
                            </shaderPart>
                        </composedShader>
                    </appearance>
                    <plane solid="false"></plane>
                </shape>
            </group>

        </scene>
    </x3d>

    <div id="gamepadPrompt"></div>

    <script>
    var runtime = null;
    var rtLeft, rtRight;
    var lastW, lastH;
    var degreeToRadiansFactor = Math.PI / 180;

    x3dom.fields.Quaternion.prototype.setFromEulerYXZ = function (alpha, beta, gamma) {

        var c1 = Math.cos( alpha / 2 );
        var c2 = Math.cos( beta / 2 );
        var c3 = Math.cos( gamma / 2 );
        var s1 = Math.sin( alpha / 2 );
        var s2 = Math.sin( beta / 2 );
        var s3 = Math.sin( gamma / 2 );

        this.x = s1 * c2 * c3 + c1 * s2 * s3;
        this.y = c1 * s2 * c3 - s1 * c2 * s3;
        this.z = c1 * c2 * s3 - s1 * s2 * c3;
        this.w = c1 * c2 * c3 + s1 * s2 * s3;
    }

    var MYAPP={"deviceOrientation":null, "screenOrientation":null};
    onDeviceOrientationChangeEvent = (function(rawEvtData) {
        this.deviceOrientation = rawEvtData;
    }).bind(MYAPP);

    window.addEventListener('deviceorientation', onDeviceOrientationChangeEvent, false);

    function deg2rad(deg){return deg * degreeToRadiansFactor;}

    document.onload = function ()
    {
        runtime = document.getElementById('x3dElement').runtime;
        rtLeft = document.getElementById('rtLeft');
        rtRight = document.getElementById('rtRight');
        //rtLeft._x3domNode.lensCenter = 0;
        //rtRight._x3domNode.lensCenter = 0;

        lastW = +runtime.getWidth();
        lastH = +runtime.getHeight();

        var hw = Math.round(lastW / 2);
        rtLeft.setAttribute('dimensions',  hw + ' ' + lastH + ' 4');
        rtRight.setAttribute('dimensions', hw + ' ' + lastH + ' 4');

        var element = document.getElementById("x3dElement");
        MYAPP.viewpoint = document.getElementById('vpp');

        element.runtime.exitFrame = function() {
            // check if screensize changed
            var w = +runtime.getWidth();
            var h = +runtime.getHeight();
            if (w != lastW || h != lastH)
            {
                var half = Math.round(w / 2);
                rtLeft.setAttribute('dimensions',  half + ' ' + h + ' 4');
                rtRight.setAttribute('dimensions', half + ' ' + h + ' 4');
                lastW = w;
                lastH = h;
            }
            //handle device orientation change
            if(!MYAPP.deviceOrientation)
                return;
            var q0 = x3dom.fields.Quaternion.axisAngle(new x3dom.fields.SFVec3f(0,0,1),-deg2rad(window.orientation)); // phone rotation offset
            var q = new x3dom.fields.Quaternion();
            q.setFromEulerYXZ(deg2rad(MYAPP.deviceOrientation.beta), deg2rad(MYAPP.deviceOrientation.alpha), -deg2rad(MYAPP.deviceOrientation.gamma));

            var q1 = new x3dom.fields.Quaternion.axisAngle(new x3dom.fields.SFVec3f(1,0,0),-Math.PI/2); // device orientation points upwards. rotate down to camera orientation

            q = q.multiply(q1);
            q = q.multiply(q0);

            var aa = q.toAxisAngle();

            MYAPP.viewpoint.setAttribute("orientation", aa[0].x + " " + aa[0].y + " " + aa[0].z + " " + aa[1]);
        };
    }

    function fullscreen() {
        //lens center auf null setzten
        rtLeft = document.getElementById('rtLeft');
        rtRight = document.getElementById('rtRight');
        rtLeft._x3domNode.lensCenter = 0;
        rtRight._x3domNode.lensCenter = 0;

        //fullscreen aktivieren
        container = document.getElementById('x3dElement');
        if (container.requestFullscreen) {
            container.requestFullscreen();
        } else if (container.msRequestFullscreen) {
            container.msRequestFullscreen();
        } else if (container.mozRequestFullScreen) {
            container.mozRequestFullScreen();
        } else if (container.webkitRequestFullscreen) {
            container.webkitRequestFullscreen();
        }
    }
	
	//gamepad support
    var hasGP = false;

    function canGame() {
        return "getGamepads" in navigator;
    }

    if(canGame()) {

        var prompt = "To begin using your gamepad, connect it and press any button!";
        $("#gamepadPrompt").text(prompt);

        $(window).on("gamepadconnected", function() {
            hasGP = true;
            $("#gamepadPrompt").html("Gamepad connected!");
            repGP = window.setInterval(checkGamepad,100);
        });

        $(window).on("gamepaddisconnected", function() {
            $("#gamepadPrompt").text(prompt);
            window.clearInterval(repGP);
        });

        //setup an interval for Chrome
        var checkGP = window.setInterval(function() {
            if(navigator.getGamepads()[0]) {
                if(!hasGP) $(window).trigger("gamepadconnected");
                window.clearInterval(checkGP);
            }
        }, 100);

        function checkGamepad() {
            var gp = navigator.getGamepads()[0];
            var axeLF = gp.axes[0];
            var axeUP = gp.axes[1];
            var sensFactor = 5;

            var position = document.getElementById('vpp').getFieldValue('position');

            position.x = position.x +(axeUP /sensFactor);
            position.z = position.z -(axeLF /sensFactor);
            document.getElementById('vpp').setFieldValue('position',position);

        }
    }

</script>
</body>
</html>
